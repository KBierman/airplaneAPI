<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script type="text/javascript">
            // Variables
            let authHeaderValue = null;
            let username = null;
            let password = null;

            // Login functions
            function login() {
                // Grab variables
                username = document.getElementById("username_field").value;
                password = document.getElementById("password_field").value;
                authHeaderValue = "Basic " + btoa(username + ":" + password); // btoa turns it into base64 encoding
                console.log("authHeaderValue: " + authHeaderValue)

                // XMLHttpRequest to send base64 encoded user login information and then stores it in authHeaderValue
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('GET', '');
                xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        document.getElementById("response_message").innerHTML = "Welcome, " + username;
                        is_user_logged_in(true);
                        console.log("Login Successful!");
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                        document.getElementById("response_message").innerHTML = "Invalid username/password!";
                        is_user_logged_in(false);
                        console.log("Login Unsuccessful!")
                    }
                }
                xmlHttp.send();
            }

            function sign_up() {
                // Grab variables
                let username = document.getElementById("username_field").value;
                let first_name = document.getElementById("firstname_field").value;
                let last_name = document.getElementById("lastname_field").value;
                let email = document.getElementById("email_field").value;
                let phone_number = document.getElementById("phonenumber_field").value;
                let password = document.getElementById("password_field").value;
                let confirm_password = document.getElementById("confirmpass_field").value;

                // Compares passwords
                if (password !== confirm_password) {
                    document.getElementById("response.message").innerHTML = `Passwords don't match! Please check your password!`
                    return console.log(`Signup Unsuccessful!\nPasswords don't match!`);
                }

                // Creates JSON for user
                let user =
                    {
                        "username": username,
                        "firstName": first_name,
                        "lastName": last_name,
                        "userPassword": password,
                        "userEmail": email,
                        "userPhoneNumber": phone_number
                    }

                // Checks for any null values in JSON
                for (let key in user) {
                    if (!user[key]) {
                        document.getElementById("response_message").innerHTML = `Please fill out all fields!`;
                        return console.log(`Signup Unsuccessful!\n(JSON had a key that was null!) Key: ${key} | Value: ${user[key]}`);
                    }
                }

                // Sends JSON to API
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('POST', '/api/user/false');
                xmlHttp.setRequestHeader("Content-Type", 'application/json');
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        if (this.responseText === "true") {
                            send_to_login()
                            console.log("Signup Successful!");
                        } else { // If the username already existed, will return this (Refer to UserBLL for username check function)
                            document.getElementById("response_message").innerHTML = `Username already exists!`;
                            console.log("Signup Unsuccessful!");
                        }
                    }
                }
                xmlHttp.send(JSON.stringify(user));
            }

            function log_out() {
                authHeaderValue = null;
                username = null;
                password = null;
                console.log("authHeaderValue: " + authHeaderValue)
                is_user_logged_in(false);
                send_to_login();
            }

            // Ticket CRUD Functions
            // Create
            function createTicket(user, flight) {
                console.log("Called createTicket()...");
                let current_date = new Date();
                let dd = String(current_date.getDate()).padStart(2, '0');
                let mm = String(current_date.getMonth() + 1).padStart(2, '0'); //January is 0!
                let yyyy = current_date.getFullYear();

                current_date = mm + '/' + dd + '/' + yyyy;

                let ticket =
                    {
                        "fltNo": flight.fltNo,
                        "dateOfJourney": flight.flightDate,
                        "userID": user.userID,
                        "firstName": user.firstName,
                        "lastName": user.lastName,
                        "email": user.userEmail,
                        "fare": flight.fare,
                        "status": flight.flightStatus,
                        "reservedBy": user.username,
                        "dateOfReservation": current_date
                    }

                console.log(ticket);

                // Sends JSON to API
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('POST', '/api/ticket');
                xmlHttp.setRequestHeader("Content-Type", 'application/json');
                xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        document.getElementById("response_message").innerHTML = "Ticket bought successfully!";
                        document.getElementById("container").innerHTML = `
                            <div>
                                Origin: ${flight.origin} | Destination: ${flight.destination} | Flight Date: ${flight.flightDate} | Departure Time: ${flight.depTime} | Seats Available: ${flight.seatsEmpty} | Fare: ${flight.fare}
                            </div>
                            <div id="response_message"></div>
                            <br />
                            `;
                        console.log("createTicket() was Successful!");
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                        document.getElementById("response_message").innerHTML = "Couldn't buy ticket! Please try again later...";
                        console.log("createTicket() was Unsuccessful!");
                    }
                }
                xmlHttp.send(JSON.stringify(ticket));
            }

            // Find
            function readAllTicketsFromUser(userID) {
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('GET', '/api/ticket/' + userID);
                xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        let tickets = JSON.parse(this.responseText);
                        for (let ticket of tickets) {
                            let ticket_html = `
                                <div>
                                    Ticket Number: ${ticket.ticketNo} | Flight Number: ${ticket.fltNo} | Flight Date: ${ticket.dateOfJourney} | First Name: ${ticket.firstName} | Last Name: ${ticket.lastName} | Fare: ${ticket.fare} | Flight Status: ${ticket.status} | Date of Reservation: ${ticket.dateOfReservation}
                                </div>
                                <br />
                                `;
                            tickets_list.innerHTML += ticket_html;
                        }
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {

                    }
                }
                xmlHttp.send();
            }

            // Flight CRUD Functions
            // Find
            function readAllCorrespondingFlights() {
                let origin = document.getElementById("flightorigin_field").value;
                let destination = document.getElementById("flightdestination_field").value;
                let departure_date = document.getElementById("departuredate_field").value
                console.log("Called readAllCorrespondingFlights()...");

                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open("GET", "/api/flight/" + origin + "/" + destination + "/" + departure_date, true);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        let flights = JSON.parse(this.responseText);
                        if (flights === undefined || flights.length == 0) {
                            document.getElementById("response_message").innerHTML = "Flight not found!";
                            document.getElementById("displayFlights").innerHTML = "";
                            console.log("readAllCorrespondingFlights() was Unsuccessful!");
                        } else {
                            document.getElementById("response_message").innerHTML = "";
                            renderFlights(flights);
                            console.log("readAllCorrespondingFlights() was Successful!");
                            console.log(flights);
                        }
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 500) {
                        document.getElementById("response_message").innerHTML = "Flight not found!";
                        document.getElementById("displayFlights").innerHTML = "";
                        console.log("readAllCorrespondingFlights() was Unsuccessful!");
                    }
                }
                xmlHttp.send();
            }

            function readFlightByFlightNumber(flightNumber, user) {
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open("GET", "/api/flight/" + flightNumber, true);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        let flight = JSON.parse(this.responseText);

                        console.log("readFlightByFlightNumber()")
                        console.log(flight);
                        console.log("readFlightByFlightNumber()")
                        console.log(user);
                        document.getElementById("response_message").innerHTML = "";
                        document.getElementById("container").innerHTML = `
                            <div>
                                Origin: ${flight.origin} | Destination: ${flight.destination} | Flight Date: ${flight.flightDate} | Departure Time: ${flight.depTime} | Seats Available: ${flight.seatsEmpty} | Fare: ${flight.fare}
                                <button id='buy' onclick='createTicket(${JSON.stringify(user)}, ${JSON.stringify(flight)})'>Buy</button>
                            </div>
                            <div id="response_message"></div>
                            <br />
                            `;
                        console.log("readAllCorrespondingFlights() was Successful!");
                        console.log(flight);
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 500) {
                        document.getElementById("response_message").innerHTML = "Flight not found!";
                        document.getElementById("displayFlights").innerHTML = "";
                        console.log("readAllCorrespondingFlights() was Unsuccessful!");
                    }
                }
                xmlHttp.send();
            }

            function renderFlights(flights) {
                let flights_list = document.getElementById("displayFlights");
                flights_list.innerHTML = "";
                for (let flight of flights) {
                    let flight_html = `
                        <div>
                            Origin: ${flight.origin} | Destination: ${flight.destination} | Flight Date: ${flight.flightDate} | Departure Time: ${flight.depTime} | Seats Available: ${flight.seatsEmpty} | Fare: ${flight.fare}
                            <button id='reserve' onclick='send_to_flight_res("${flight.fltNo}")'>Reserve</button>
                        </div>
                        <br />
                        `;

                    flights_list.innerHTML += flight_html;
                }
            }

            // User CRUD functions
            // Find
            function findUserByUsername() {
                console.log("Called findUserByUsername()...")
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('GET', '/api/user/' + username);
                xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        console.log("findUserByUsername() was Successful!");
                        console.log(JSON.parse(this.responseText));
                        JSON.parse(this.responseText);
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                        console.log("findUserByUsername() was Unsuccessful!");
                    }
                }
                xmlHttp.send();
            }

            function loadAllUsersInMemory() {
                console.log("Called loadAllUsersInMemory()");
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('GET', '/api/loadusers');
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        console.log("loadAllUsersInMemory() was Successful!");
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                        console.log("loadAllUsersInMemory() was Unsuccessful!");
                    }
                }
                xmlHttp.send();
            }

            function updateUserIfEmptyField(user) {
                console.log("Called updateUserIfEmptyField()...")
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('GET', '/api/user/' + username);
                xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        let old_user = JSON.parse(this.responseText);

                        // Checks for any null values in JSON
                        for (let key in user) {
                            if (!user[key]) {
                                user[key] = old_user[key];
                                console.log(user[key]);
                            }
                            console.log(user[key]);
                        }

                        console.log(user);

                        // Sends JSON to API
                        let xmlHttp = new XMLHttpRequest();
                        xmlHttp.open('PUT', '/api/user/' + username);
                        xmlHttp.setRequestHeader("Content-Type", 'application/json');
                        xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                        xmlHttp.onreadystatechange = function () {
                            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                                document.getElementById("response_message").innerHTML = "Your info has been updated successfully!";
                                console.log("User Update Successful!");
                            } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                                document.getElementById("response_message").innerHTML = "Your info couldn't be updated, please try again later!";
                                console.log("User Update Unsuccessful!");
                            }
                        }
                        xmlHttp.send(JSON.stringify(user));
                        console.log("findUserByUsername() was Successful!");
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                        console.log("findUserByUsername() was Unsuccessful!");
                    }
                }
                xmlHttp.send();
            }

            // Update
            function updateUser() {
                console.log("Called updateUser()...");
                let email = document.getElementById("email_field").value;
                let phone_number = document.getElementById("phonenumber_field").value;
                let password = document.getElementById("password_field").value;
                let confirm_password = document.getElementById("confirmpassword_field").value;

                let user =
                    {
                        "userPassword": password,
                        "userEmail": email,
                        "userPhoneNumber": phone_number
                    }

                if (!email || !phone_number || !password) {
                    updateUserIfEmptyField(user);
                } else {
                    // Compares passwords
                    if (password !== confirm_password) {
                        document.getElementById("response.message").innerHTML = `Passwords don't match! Please check your password!`
                        return console.log(`Signup Unsuccessful!\nPasswords don't match!`);

                    }

                    // Checks for any null values in JSON
                    for (let key in user) {
                        if (!user[key]) {
                            document.getElementById("response_message").innerHTML = `Please fill out all fields!`;
                            return console.log(`Signup Unsuccessful!\n(JSON had a key that was null!) Key: ${key} | Value: ${user[key]}`);
                        }
                    }

                    // Sends JSON to API
                    let xmlHttp = new XMLHttpRequest();
                    xmlHttp.open('PUT', '/api/user/' + username);
                    xmlHttp.setRequestHeader("Content-Type", 'application/json');
                    xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                    xmlHttp.onreadystatechange = function () {
                        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                            document.getElementById("response_message").innerHTML = "Your info has been updated successfully!";
                            console.log("User Update Successful!");
                        } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                            document.getElementById("response_message").innerHTML = "Your info couldn't be updated, please try again later!";
                            console.log("User Update Unsuccessful!");
                        }
                    }
                    xmlHttp.send(JSON.stringify(user));
                }
            }

            // DON'T FORGET DUMBASSSSSS, these functions break the mongodb by removing values from the user object (Maybe it has to do with how the buttons in the form work, maybe since they are a 'submit' type button, all of them trigger, resulting in the other functions grabbing empty values and then updating the mongodb? Also don't forget to check application.properties because you changed the URI again) ok have a nice day and go to sleep :>

            // Page functions
            function send_to_login() {
                document.getElementById("container").innerHTML = `
                  <h3>Login:</h3>
                  <label>Username: </label>
                  <input type="text" id="username_field" />
                  <br/>

                  <label>Password: </label>
                  <input type="password" id="password_field" />
                  <br/>

                  <button onclick="login();">Login</button>
                  <a onclick="send_to_signup()" href="#">Don't have an account?</a>
                  <br/>
                  <div id="response_message"></div>
                  <br />
                  `
            }

            function send_to_signup() {
                document.getElementById("container").innerHTML = `
                  <form>
                    <h1>SIGN UP</h1>
                    <label for="username_field">Username: </label>
                    <input type="text" id="username_field" required>
                    <br />
                    <label for="firstname_field">First Name: </label>
                    <input type="text" id="firstname_field" required>
                    <br />
                    <label for="lastname_field">Last Name: </label>
                    <input type="text" id="lastname_field" required>
                    <br />
                    <label for="email_field">Email: </label>
                    <input type="email" id="email_field" required>
                    <br />
                    <label for="phonenumber_field">Phone Number: </label>
                    <input type="tel" id="phonenumber_field"
                           pattern="^(+\\d{1,2}\\s)?(?\\d{3})?[\\s.-]\\d{3}[\\s.-]\\d{4}$" required>
                    <br />
                    <small>Format: (+0)-111-222-3333</small>
                    <br />
                    <label for="password_field">Password: </label>
                    <input type="password" id="password_field" required>
                    <br />
                    <label for="confirmpass_field">Confirm Password: </label>
                    <input type="password" id="confirmpass_field">
                    <br />
                    <input type="submit" onclick="sign_up()">
                    <br />
                  </form>
                  <div id="response_message"></div>
                  `
            }

            function send_to_flight_lookup() {
                document.getElementById("container").innerHTML = `
                    <label>From:</label>
                    <input type="text" id="flightorigin_field" />
                    <br />
                    <label>To:</label>
                    <input type="text" id="flightdestination_field" />
                    <br />
                    <label>Departure Date:</label>
                    <input type="text" id="departuredate_field" />
                    <br />
                    <button onclick="readAllCorrespondingFlights();">Find Flights</button>
                    <br/>
                    <div id="response_message"></div>

                    <ul id="displayFlights" style="list-style-type:none"></ul>
                    `
            }

            function send_to_flight_res(flightNumber) {
                if (authHeaderValue == null) {
                    send_to_login();
                } else {
                    console.log("Called send_to_flight_res()...")
                    let xmlHttp = new XMLHttpRequest();
                    xmlHttp.open('GET', '/api/user/' + username);
                    xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                    xmlHttp.onreadystatechange = function () {
                        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                            let user = JSON.parse(this.responseText);
                            console.log(user);
                            readFlightByFlightNumber(flightNumber, user);
                            console.log("send_to_flight_res() was Successful!");
                        } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                            console.log("send_to_flight_res() was Unsuccessful!");
                        }
                    }
                    xmlHttp.send();
                }
            }

            function send_to_user_profile() {
                document.getElementById("container").innerHTML = `
                    <h1 id="profile_header"></h1>
                    <nav id="user_navbar">
                        <a onclick="send_to_update_user()" href="#">Update Info</a>
                        <a onclick="send_to_user_tickets()" href="#">Reserved Flights</a>
                    </nav>
                    <div id="user_dashboard">
                        <form>
                            <label for="email_field">Email: </label>
                            <input type="email" id="email_field" required>
                            <br />
                            <label for="phonenumber_field">Phone Number: </label>
                            <input type="tel" id="phonenumber_field" pattern="^(+\\d{1,2}\\s)?(?\\d{3})?[\\s.-]\\d{3}[\\s.-]\\d{4}$" required>
                            <br />
                            <small>Format: (+0)-111-222-3333</small>
                            <br />
                            <label for="password_field">Password: </label>
                            <input type="password" id="password_field" required>
                            <br />
                            <label for="confirmpassword_field">Confirm Password: </label>
                            <input type="password" id="confirmpassword_field">
                            <br />
                            <input type="submit" onclick="updateUser()">
                            <br />
                        </form>
                        <div id="response_message"></div>
                    </div>
                    `
                document.getElementById("profile_header").innerHTML = `${username}'s Profile`
            }

            function send_to_update_user() {
                document.getElementById("user_dashboard").innerHTML = `
                    <form>
                            <h1 id="profile_header"></h1>
                            <label for="email_field">Email: </label>
                            <input type="email" id="email_field" required>
                            <br />
                            <label for="phonenumber_field">Phone Number: </label>
                            <input type="tel" id="phonenumber_field" pattern="^(+\\d{1,2}\\s)?(?\\d{3})?[\\s.-]\\d{3}[\\s.-]\\d{4}$" required>
                            <br />
                            <small>Format: (+0)-111-222-3333</small>
                            <br />
                            <label for="password_field">Password: </label>
                            <input type="password" id="password_field" required>
                            <br />
                            <label for="confirmpassword_field">Confirm Password: </label>
                            <input type="password" id="confirmpassword_field">
                            <br />
                            <input type="submit" onclick="updateUser()">
                            <br />
                        </form>
                        <div id="response_message"></div>
                `
            }

            function send_to_user_tickets() {
                let xmlHttp = new XMLHttpRequest();
                xmlHttp.open('GET', '/api/user/' + username);
                xmlHttp.setRequestHeader('Authorization', authHeaderValue);
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        let user = JSON.parse(this.responseText);
                        document.getElementById("user_dashboard").innerHTML = `<div id="tickets_list"></div>`;
                        readAllTicketsFromUser(user.userID);
                        console.log("send_to_user_tickets() was Successful!");
                    } else if (this.readyState === XMLHttpRequest.DONE && this.status === 401) {
                        console.log("send_to_user_tickets() was Unsuccessful!");
                    }
                }
                xmlHttp.send();
            }

            // Navbar functions
            function is_user_logged_in(isTrue) {
                if (isTrue === true) {
                    document.getElementById("navbar").innerHTML = `
                        <a onclick="send_to_flight_lookup()" href="#">Reserve a Flight</a>
                        <a onclick="send_to_user_profile()" href="#">Profile</a>
                        <a onclick="log_out()" href="#">Log Out</a>
                        `
                } else {
                    document.getElementById("navbar").innerHTML = `
                        <a onclick="send_to_flight_lookup()" href="#">Reserve a Flight</a>
                        <a onclick="send_to_signup()" href="#">Signup</a>
                        <a onclick="send_to_login()" href="#">Login</a>
                        `
                }
            }

            window.onload = function () {
                loadAllUsersInMemory(); // Will load all the users in the databse into memory
            }
        </script>
        <title>Welcome Page</title>
    </head>
    <body>
        <nav id="navbar">
            <a onclick="send_to_flight_lookup()" href="#">Reserve a Flight</a>
            <a onclick="send_to_signup()" href="#">Signup</a>
            <a onclick="send_to_login()" href="#">Login</a>
        </nav>
        <h1>Welcome to SkyHappy</h1>

        <div id="container">
            <label for="flightorigin_field">From:</label>
            <input type="text" id="flightorigin_field"/>
            <br/>
            <label for="flightdestination_field">To:</label>
            <input type="text" id="flightdestination_field"/>
            <br/>
            <label for="departuredate_field">Departure Date:</label>
            <input type="text" id="departuredate_field"/>
            <br/>
            <button onclick="readAllCorrespondingFlights();">Find Flights</button>
            <br/>
            <div id="response_message"></div>

            <div>
                <ul id="displayFlights" style="list-style-type:none"></ul>
            </div>
        </div>
    </body>
</html>